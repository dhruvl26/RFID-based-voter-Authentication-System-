#include <WiFi.h>
#include <FirebaseESP32.h>
#include <SPI.h>
#include <MFRC522.h>

// Replace with your network credentials
#define WIFI_SSID "LALU"
#define WIFI_PASSWORD "wwrg6948"

// Replace with your Firebase project credentials
#define FIREBASE_HOST "https://rfid-based-voting-system-default-rtdb.firebaseio.com/"
#define FIREBASE_AUTH "0Wq89ov7fcfMsm3JlRvi4WfPu0sPOHea5K9Iu6s3"
#define FIREBASE_API_KEY "AIzaSyALodngOVIp3dpRuRy7KZT0qFHh1IctxAk"

// Pin Definitions
#define BUTTON_PIN 15  // Button for voting (GPIO 15 as defined in your case)
#define SS_PIN 21  // RFID SDA (SS_PIN) - GPIO 21
#define RST_PIN 22  // RFID RST_PIN - GPIO 22

// Initialize RFID reader
MFRC522 mfrc522(SS_PIN, RST_PIN);

// Firebase and WiFi Objects
FirebaseData firebaseData;
FirebaseAuth auth;
FirebaseConfig config;

void setup() {
  // Start Serial communication for debugging
  Serial.begin(9600);

  // Connect to Wi-Fi
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.println("Connecting to WiFi...");
  }
  Serial.println("Connected to WiFi");

  // Firebase configuration
  config.host = FIREBASE_HOST;
  config.api_key = FIREBASE_API_KEY;
  config.signer.tokens.legacy_token = FIREBASE_AUTH;

  // Initialize Firebase
  Firebase.begin(&config, &auth);

  // Initialize RFID reader
  SPI.begin();  // Start SPI bus
  mfrc522.PCD_Init();  // Initialize the MFRC522 RFID reader

  // Set up button pin
  pinMode(BUTTON_PIN, INPUT_PULLUP);  // Set button pin as input
}

void loop() {
  // Look for new RFID tags
  if (mfrc522.PICC_IsNewCardPresent()) {
    if (mfrc522.PICC_ReadCardSerial()) {
      // Read the UID of the RFID card
      String uid = "";
      for (byte i = 0; i < mfrc522.uid.size; i++) {
        uid += String(mfrc522.uid.uidByte[i], HEX);
      }

      // Print the UID to the Serial Monitor
      Serial.print("UID detected: ");
      Serial.println(uid);

      // Check UID in Firebase under alloweduids path
      String path = "/alloweduids/" + uid;
      if (Firebase.getString(firebaseData, path)) {
        if (firebaseData.dataType() == "string" && firebaseData.stringData() == "authorized") {
          Serial.println("UID verified: Access granted!");

          // Check if the UID has already voted
          String votePath = "/vote/" + uid;
          if (Firebase.getString(firebaseData, votePath)) {
            if (firebaseData.dataType() == "string" && firebaseData.stringData() == "voted") {
              Serial.println("This UID has already voted.");
            }
          } else {
            // Wait for button press to cast the vote
            Serial.println("Waiting for vote...");
            while (digitalRead(BUTTON_PIN) == HIGH) {
              delay(100);  // Wait for button press
            }

            // Mark as voted in Firebase
            if (Firebase.setString(firebaseData, votePath, "voted")) {
              Serial.println("Vote successfully cast!");
            } else {
              Serial.println("Error casting vote: " + firebaseData.errorReason());
            }
          }
        } else {
          Serial.println("UID not authorized.");
        }
      } else {
        Serial.println("Error checking Firebase: " + firebaseData.errorReason());
      }
    }
  }
}
